<!DOCTYPE html><html lang="en"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 小程序:获取用户UnionID · 马小宝</title><meta name="description" content="小程序:获取用户UnionID - MaXiaoBao"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/egg.ico"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://maxiuli.com/atom.xml" title="马小宝"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/egg.ico"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/maxxiaobao" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/about/" target="_self" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">小程序:获取用户UnionID</h1><div class="post-info">Oct 16, 2019</div><div class="post-content"><blockquote>
<p>公众平台: 服务号/订阅号/小程序<br>开放平台: 移动应用/网站应用/公众帐号开发/第三方平台开发</p>
</blockquote>
<ul>
<li>OpenID = 用户微信号 &amp; 公众平台 APPID （两个数据加密得到的字符串）</li>
<li>UnionID = 用户微信号 &amp; 开放平台 APPID（两个数据加密得到的字符串）</li>
<li>同一用户，对同一个微信开放平台帐号下的不同应用，UnionID 是相同的。</li>
</ul>
<h3 id="1-获取登录凭证（code）"><a href="#1-获取登录凭证（code）" class="headerlink" title="1.获取登录凭证（code）"></a>1.获取登录凭证（code）</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">wx.login(&#123;</span><br><span class="line">  success(res) &#123;</span><br><span class="line">    <span class="comment">// res = &#123;code&#125;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p><code>res.code</code>: 用户登录凭证（有效期五分钟）。开发者需要在开发者服务器后台调用 auth.code2Session，使用 code 换取 openid 和 session_key 等信息</p>
<a id="more"></a>
<h3 id="2-授权"><a href="#2-授权" class="headerlink" title="2. 授权"></a>2. 授权</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">open-type</span>=<span class="string">"getUserInfo"</span> <span class="attr">bindgetuserinfo</span>=<span class="string">"getUserInfoHandler"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">getUserInfoHandler(e)&#123;</span><br><span class="line">	<span class="comment">// 用户拒绝授权</span></span><br><span class="line">	<span class="comment">//e.detail.errMsg = "getUserInfo:fail auth deny"</span></span><br><span class="line">	<span class="comment">// 同意授权</span></span><br><span class="line">	&#123;</span><br><span class="line">		UserInfo: &#123;</span><br><span class="line">			nickName,</span><br><span class="line">			avatarUrl,</span><br><span class="line">			gender, <span class="comment">// [0, 1, 2]</span></span><br><span class="line">			country,</span><br><span class="line">			province,</span><br><span class="line">			city,</span><br><span class="line">			language <span class="comment">// [en, zh_CN, zh_TW]</span></span><br><span class="line">		&#125;,</span><br><span class="line">		rawData, <span class="comment">// 不包括敏感信息的原始数据字符串，用于计算签名</span></span><br><span class="line">		signature,</span><br><span class="line">		encryptedData, <span class="comment">// 包括敏感数据在内的完整用户信息的加密数据</span></span><br><span class="line">		iv, <span class="comment">//加密算法的初始向量</span></span><br><span class="line">		cloudID, <span class="comment">//敏感数据对应的云 ID，开通云开发的小程序才会返回</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-服务端解密-unionId"><a href="#3-服务端解密-unionId" class="headerlink" title="3. 服务端解密 unionId"></a>3. 服务端解密 unionId</h3><p><code>( code, encryptedData, iv)</code><br>||<br>code =&gt; session_key<br>||<br>||<br> 服务端解密<br>||</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"openId"</span>: <span class="string">"OPENID"</span>,</span><br><span class="line">  <span class="attr">"nickName"</span>: <span class="string">"NICKNAME"</span>,</span><br><span class="line">  <span class="attr">"gender"</span>: GENDER,</span><br><span class="line">  <span class="attr">"city"</span>: <span class="string">"CITY"</span>,</span><br><span class="line">  <span class="attr">"province"</span>: <span class="string">"PROVINCE"</span>,</span><br><span class="line">  <span class="attr">"country"</span>: <span class="string">"COUNTRY"</span>,</span><br><span class="line">  <span class="attr">"avatarUrl"</span>: <span class="string">"AVATARURL"</span>,</span><br><span class="line">  <span class="attr">"unionId"</span>: <span class="string">"UNIONID"</span>,</span><br><span class="line">  <span class="attr">"watermark"</span>: &#123;</span><br><span class="line">    <span class="attr">"appid"</span>: <span class="string">"APPID"</span>,</span><br><span class="line">    <span class="attr">"timestamp"</span>: TIMESTAMP</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</div></article></div></section><footer><div class="paginator"><a href="/2020/02/26/Git默认不区分文件名大小写/" class="prev">PREV</a><a href="/2019/09/29/小程序2/" class="next">NEXT</a></div><style>.span{display: inline-block;width: 20px;height: 20px;font-size: 14px;line-height: 20px;text-align: center;}
</style><div class="copyright"><p>© 2015 - 2020 <a href="https://maxiuli.com">MaXiaoBao</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a target="_blank">hexo-theme-apollo</a>.<br><span class="span" style="background-color:#FF33FF;color:#fff">遇</span><span class="span" style="background-color:#FF3366;color:#fff">见</span><span class="span" style="background-color:#FF5433;color:#fff">更</span><span class="span" style="background-color:#FF9533;color:#fff">好</span><span class="span" style="background-color:#FFE733;color:#fff">的</span><span class="span" style="background-color:#79E22D;color:#fff">自</span><span class="span" style="background-color:#2B94D6;color:#fff">己</span><span class="span" style="background-color:#6A2BD6;color:#fff">❤</span></p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>